/**
 * Tesseract.js 简化版本
 * 提供基本的 OCR 接口，实际功能需要完整版本
 */

(function(global) {
  'use strict';

  // 模拟 Tesseract.js API
  const Tesseract = {
    /**
     * 创建 Worker
     */
    createWorker: function(options = {}) {
      return Promise.resolve(new TesseractWorker(options));
    },

    /**
     * 识别文本（简化版本）
     */
    recognize: function(image, options = {}) {
      const worker = new TesseractWorker();
      return worker.recognize(image, options);
    }
  };

  /**
   * Tesseract Worker 模拟类
   */
  class TesseractWorker {
    constructor(options = {}) {
      this.options = options;
      this.isReady = false;
      this.languages = [];
    }

    /**
     * 加载语言包
     */
    async loadLanguage(langs) {
      console.log('模拟加载语言包:', langs);
      this.languages = Array.isArray(langs) ? langs : [langs];
      return Promise.resolve();
    }

    /**
     * 初始化
     */
    async initialize(langs) {
      console.log('模拟初始化 OCR 引擎:', langs);
      this.isReady = true;
      return Promise.resolve();
    }

    /**
     * 识别文本
     */
    async recognize(image, options = {}) {
      if (!this.isReady) {
        throw new Error('Worker 未初始化');
      }

      // 模拟进度回调
      if (options.logger) {
        const progressSteps = [
          { status: 'loading image', progress: 0.1 },
          { status: 'preprocessing', progress: 0.3 },
          { status: 'recognizing text', progress: 0.5 },
          { status: 'recognizing text', progress: 0.7 },
          { status: 'recognizing text', progress: 0.9 },
          { status: 'done', progress: 1.0 }
        ];

        for (const step of progressSteps) {
          options.logger(step);
          await new Promise(resolve => setTimeout(resolve, 200));
        }
      }

      // 获取图片信息
      const imageInfo = await this.getImageInfo(image);
      
      // 返回模拟结果
      return {
        data: {
          text: `[OCR 模拟结果]\n\n检测到图片: ${imageInfo.name || 'unknown'}\n尺寸: ${imageInfo.width || 0}x${imageInfo.height || 0}\n\n这是一个模拟的 OCR 结果。\n要获得真实的文字识别功能，请加载完整版本的 Tesseract.js 库。\n\n您可以手动输入图片中的文字内容。`,
          confidence: 85,
          words: [],
          lines: [],
          paragraphs: [],
          blocks: []
        }
      };
    }

    /**
     * 获取图片信息
     */
    async getImageInfo(image) {
      if (image instanceof File) {
        return {
          name: image.name,
          size: image.size,
          type: image.type,
          width: 0,
          height: 0
        };
      }
      
      return {
        name: 'image',
        size: 0,
        type: 'unknown',
        width: 0,
        height: 0
      };
    }

    /**
     * 设置参数
     */
    async setParameters(params) {
      console.log('设置 OCR 参数:', params);
      return Promise.resolve();
    }

    /**
     * 终止 Worker
     */
    async terminate() {
      console.log('终止 OCR Worker');
      this.isReady = false;
      return Promise.resolve();
    }
  }

  // 导出到全局
  global.Tesseract = Tesseract;

  // 如果是 Node.js 环境
  if (typeof module !== 'undefined' && module.exports) {
    module.exports = Tesseract;
  }

})(typeof window !== 'undefined' ? window : global);